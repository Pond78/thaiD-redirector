<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Barcode Scanner</title>
  <!-- Include html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      text-align: center;
    }

    h1 {
      color: #333;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #input-section {
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }

    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      box-sizing: border-box;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    button:active {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #ccc;
    }

    #status {
      margin: 10px 0;
      color: #666;
      font-size: 0.9rem;
    }

    #scanner-container {
      margin-top: 20px;
      display: none;
      /* Hidden until data loaded */
    }

    #reader {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }

    #result-display {
      /* margin-top: 20px;  Removed as it is now above camera */
      background-color: #fff;
      /* Ensure visibility */
      border: 1px solid #ddd;
      border-radius: 12px;
      display: none;
    }

    .match {
      background-color: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      animation: pulse 0.5s ease-in-out;
    }

    .no-match {
      background-color: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .result-text {
      font-size: 2rem;
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }

    .scanned-code {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
      display: block;
      margin-top: 5px;
      word-break: break-all;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.2rem;
      }
    }

    .count-badge {
      background: #eee;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-left: 5px;
    }

    /* Scanner Overlay Styles */
    #scanner-wrapper {
      position: relative;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      margin: 0 auto;
    }

    #scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      /* Let clicks pass through to camera/buttons if any */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .scan-area {
      width: 250px;
      /* Match logic config */
      height: 150px;
      /* Match logic config */
      position: relative;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      /* Shaded background */
      border-radius: 4px;
      transition: box-shadow 0.3s ease, border 0.3s ease;
    }

    .scan-area.error {
      box-shadow: 0 0 0 9999px rgba(255, 0, 0, 0.5) !important;
      /* Red overlay */
      border: 4px solid #ff4444;
    }

    /* Corner Markers */

    /* Corner Markers */
    .corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: #fff;
      border-style: solid;
      border-width: 0;
    }

    .top-left {
      top: -2px;
      left: -2px;
      border-top-width: 4px;
      border-left-width: 4px;
    }

    .top-right {
      top: -2px;
      right: -2px;
      border-top-width: 4px;
      border-right-width: 4px;
    }

    .bottom-left {
      bottom: -2px;
      left: -2px;
      border-bottom-width: 4px;
      border-left-width: 4px;
    }

    .bottom-right {
      bottom: -2px;
      right: -2px;
      border-bottom-width: 4px;
      border-right-width: 4px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>ตรวจสอบใบสั่ง (v2.0 Fixed)</h1>

    <div id="input-section">
      <p style="margin-top: 0; text-align: left; font-size: 0.9rem; color: #666;">
        1. อัปโหลดไฟล์ .html/.mhtml หรือวางโค้ดในช่อง<br>
        2. กดปุ่ม "ดึงข้อมูล & เริ่มสแกน"
      </p>
      <div style="margin-bottom: 10px; text-align: left;">
        <input type="file" id="fileInput" accept=".html,.htm,.mhtml"
          style="display: block; width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      <textarea id="htmlInput" placeholder="วางโค้ด HTML <tbody>...</tbody> ที่นี่"></textarea>
      <button onclick="startScanner()">ดึงข้อมูล & เปิดกล้อง</button>
      <div id="data-status" style="margin-top: 10px; font-weight: bold;"></div>
    </div>

    <div id="scanner-container">
      <div id="count-display" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333;">
        ตรวจพบแล้ว: <span id="found-count">0</span> / <span id="total-count">0</span>
      </div>

      <div id="reader"></div>

      <div id="result-display"
        style="display: none; margin-top: 20px; padding: 10px; border: none; background: transparent;">
        <span class="result-text" id="match-status" style="display: none;"></span>
        <span class="scanned-code" id="scanned-value"
          style="font-size: 2.5rem; font-weight: 900; color: #000; display: block; text-shadow: 1px 1px 2px white;"></span>
      </div>

      <div style="margin-top: 20px; text-align: left;">
        <h3 style="font-size: 1rem; margin-bottom: 5px;">รายการที่ตรวจพบ (<span id="scanned-list-count">0</span>):</h3>
        <ul id="scanned-list"
          style="max-height: 150px; overflow-y: auto; background: #fafafa; padding: 10px; border: 1px solid #ddd; list-style-position: inside;">
          <li style="color: #999;">ยังไม่มีรายการ</li>
        </ul>

        <details style="margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
          <summary style="cursor: pointer; font-weight: bold; color: #007bff;">ดูรายการใบสั่งทั้งหมด (<span
              id="all-list-count">0</span>)</summary>
          <ul id="all-target-list" style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding-left: 20px;">
            <!-- Populated by JS -->
          </ul>
        </details>
      </div>

      <button onclick="stopScanner()" style="margin-top: 20px; background-color: #dc3545;">หยุดสแกน</button>
    </div>
  </div>

  <script>
    let orderNumbers = new Set();
    let scannedOrders = new Set();
    let html5QrcodeScanner = null;
    let audioContext = null;

    // Initialize Audio Context on user interaction
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }

    function decodeQuotedPrintable(str) {
      // Remove soft line breaks (=\r\n, =\n, =\r)
      let decoded = str.replace(/=\r?\n/g, '');
      // Decode hex sequences (=3D -> =)
      decoded = decoded.replace(/=([0-9A-F]{2})/yi, function (match, hex) {
        return String.fromCharCode(parseInt(hex, 16));
      });
      return decoded;
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        // Put content in textarea for visibility (optional) and process
        document.getElementById('htmlInput').value = content;
        // Auto-parse
        parseOrderNumbers(content);
      };
      reader.readAsText(file);
    });

    function speakPaid() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance("จ่ายแล้ว");
        utterance.lang = 'th-TH';
        window.speechSynthesis.speak(utterance);
      }
    }

    function playBeep(type) {
      if (!audioContext) initAudio();

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      if (type === 'success') {
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } else if (type === 'scan') {
        // Short high-pitched beep for scan
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(1500, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } else {
        // Optional: Error beep
      }
    }

    function parseOrderNumbers(sourceText = null) {
      let input = sourceText;
      if (!input) {
        input = document.getElementById('htmlInput').value.trim();
      }

      if (!input) {
        alert("กรุณาวางโค้ด HTML หรืออัปโหลดไฟล์ก่อน");
        return false;
      }

      // Check if MHTML/Quoted-Printable and decode
      if (input.includes('MIME-Version:') || input.includes('Content-Transfer-Encoding: quoted-printable') || input.includes('=3D')) {
        input = decodeQuotedPrintable(input);
      }

      // Create a dummy element to parse HTML safely
      // Wrap in table to ensure tbody/tr are preserved if missing parent tags
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = '<table>' + input + '</table>';

      // Find rows within the constructed table
      const rows = tempDiv.querySelectorAll('tr');

      orderNumbers.clear();
      let count = 0;

      rows.forEach(row => {
        // Target: First <td> in the row
        const firstTd = row.querySelector('td');
        if (firstTd) {
          const text = firstTd.textContent.trim();
          // specific check for length to avoid empty cells or headers if any
          if (text && text.length > 5) {
            orderNumbers.add(text);
            count++;
          }
        }
      });

      const statusDiv = document.getElementById('data-status');
      if (count > 0) {
        statusDiv.textContent = `พบข้อมูลใบสั่ง ${count} รายการ`;
        statusDiv.style.color = 'green';

        // Reset scanned set and update display
        scannedOrders.clear();
        document.getElementById('total-count').textContent = count;
        document.getElementById('found-count').textContent = '0';
        document.getElementById('scanned-list-count').textContent = '0';
        document.getElementById('all-list-count').textContent = count;

        // Populate All Targets List
        const allList = document.getElementById('all-target-list');
        allList.innerHTML = '';
        orderNumbers.forEach(num => {
          const li = document.createElement('li');
          li.textContent = num;
          allList.appendChild(li);
        });

        // Reset Scanned List
        const scannedList = document.getElementById('scanned-list');
        scannedList.innerHTML = '<li style="color: #999;">ยังไม่มีรายการ</li>';

        return true;
      } else {
        // Fallback: Check if user pasted just text or something else
        statusDiv.textContent = "ไม่พบข้อมูลใบสั่งใน HTML ที่วาง (กรุณาวางโค้ดที่มี <tr>...</tr>)";
        statusDiv.style.color = 'red';
        return false;
      }
    }

    let lastScannedCode = null;
    let lastScanTime = 0;

    function onScanSuccess(decodedText, decodedResult) {
      // Handle on success condition with the decoded message.
      console.log(`Scan result: ${decodedText}`, decodedResult);

      const currentTime = new Date().getTime();

      // Debounce: Prevent processing the same code too quickly (e.g., within 2 seconds)
      if (decodedText === lastScannedCode && (currentTime - lastScanTime < 2000)) {
        return;
      }

      // Update last scan info
      lastScannedCode = decodedText;
      lastScanTime = currentTime;

      // Play "Scan" beep for every valid scan
      playBeep('scan');

      const resultDisplay = document.getElementById('result-display');
      const matchStatus = document.getElementById('match-status');
      const scannedValue = document.getElementById('scanned-value');

      // Robust Extraction Logic:
      // 1. Keep only digits
      let rawDigits = decodedText.replace(/\D/g, '');
      let code = rawDigits;

      // 2. Search for the specific order prefix '036811'
      let matchIndex = rawDigits.indexOf('036811');
      if (matchIndex !== -1) {
        // Found '036811', valid order number starts here. Discard preceding digits.
        code = rawDigits.substring(matchIndex);
      } else {
        // 3. Fallback: Check for '36811' (missing leading zero)
        matchIndex = rawDigits.indexOf('36811');
        if (matchIndex !== -1) {
          // Found '36811', discard preceding and prepend '0'
          code = '0' + rawDigits.substring(matchIndex);
        }
      }

      // Update the display to show only the ACTUAL used code (Full format: 036811...)
      // User requested to show just the number
      scannedValue.textContent = `${code}`;

      if (orderNumbers.has(code)) {
        // Match found
        if (!scannedOrders.has(code)) {
          scannedOrders.add(code);
          document.getElementById('found-count').textContent = scannedOrders.size;
          document.getElementById('scanned-list-count').textContent = scannedOrders.size;

          // Update Scanned List UI
          const scannedList = document.getElementById('scanned-list');
          if (scannedOrders.size === 1) {
            scannedList.innerHTML = ''; // Clear "no items" message
          }
          const li = document.createElement('li');
          li.textContent = `${code}`;
          li.style.color = 'green';
          li.style.fontWeight = 'bold';

          // Prepend used for latest on top, or append for chronological
          scannedList.insertBefore(li, scannedList.firstChild);
        }

        // Delay "Paid" voice slightly so it doesn't clash with the beep
        setTimeout(() => {
          playBeep('success');
          speakPaid();
        }, 300);

        resultDisplay.className = 'match';
        // matchStatus.textContent = 'ตรงกัน (MATCH)'; // Removed to keep UI clean or add back if needed

      } else {
        // Logic for non-match

        // Visual Feedback: Red Overlay
        const scanArea = document.querySelector('.scan-area');
        if (scanArea) {
          scanArea.classList.add('error');
          setTimeout(() => scanArea.classList.remove('error'), 1000); // Remove after 1s
        }

        resultDisplay.className = 'no-match';
        matchStatus.style.display = 'block';
        matchStatus.textContent = 'ไม่พบข้อมูล (ยังไม่จ่าย)';
        matchStatus.style.color = 'red';
        scannedValue.style.color = 'red';

        // Audio Feedback: "Not Paid"
        setTimeout(() => {
          playBeep('scan'); // Optional: distinct fail beep? For now standard beep.
          speakNotPaid();
        }, 300);
      }
    }

    function speakPaid() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance("จ่ายแล้ว");
        utterance.lang = 'th-TH';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    function speakNotPaid() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance("ยังไม่จ่าย"); // Not Paid
        utterance.lang = 'th-TH';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    function onScanFailure(error) {
      // handle scan failure, usually better to ignore and keep scanning.
      // for example:
      // console.warn(`Code scan error = ${error}`);
    }

    function startScanner() {
      if (!parseOrderNumbers()) return;

      // Hide input, show scanner
      document.getElementById('input-section').style.display = 'none';
      document.getElementById('scanner-container').style.display = 'block';

      // Initialize Audio
      initAudio();

      // Use Html5Qrcode class for explicit control
      if (!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("reader");
      }

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 150 },
        aspectRatio: 1.0
      };

      // Request back camera explicitly
      // NOTE: Html5Qrcode.start throws error if config has > 1 key. 
      // We must use only { facingMode: "environment" } here, and apply resolution constraints later.
      const cameraConfig = {
        facingMode: "environment"
      };

      html5QrcodeScanner.start(
        cameraConfig,
        config,
        onScanSuccess,
        onScanFailure
      ).then(() => {
        // Apply Resolution & Auto-zoom logic after start
        setTimeout(() => {
          try {
            // Maxwell Resolution Constraints (4K ideal)
            const resolutionConstraints = {
              width: { min: 1280, ideal: 3840 },
              height: { min: 720, ideal: 2160 }
            };

            // Get current capabilities for Zoom
            const track = html5QrcodeScanner.getRunningTrackCameraCapabilities();
            console.log("Camera Capabilities:", track);

            let zoomConstraint = null;

            if (track && track.zoom) {
              const zoomCapability = track.zoom;
              // Target zoom level: 2.0x or Max if less than 2.0
              let targetZoom = Math.min(zoomCapability.max, 2.0);

              if (targetZoom < zoomCapability.min) {
                targetZoom = zoomCapability.min;
              }

              console.log(`Setting Hardware Zoom to: ${targetZoom}`);
              zoomConstraint = [{ zoom: targetZoom }];
            }

            // Combine constraints
            const finalConstraints = {
              ...resolutionConstraints,
              ...(zoomConstraint ? { advanced: zoomConstraint } : {})
            };

            console.log("Applying Constraints:", finalConstraints);
            html5QrcodeScanner.applyVideoConstraints(finalConstraints);

          } catch (e) {
            console.error("Error setting camera constraints:", e);
          }
        }, 500); // Slight delay to ensure camera is fully ready
      })
        .catch(err => {
          console.error("Error starting scanner", err);
          const debugKeys = Object.keys(cameraConfig).join(', ');
          alert(`[v2.1 Debug] Keys: ${debugKeys}\nError: ${err}`);

          // Fallback: If 1 key failed, try empty config (any camera)
          if (Object.keys(cameraConfig).length > 0) {
            console.log("Retrying with empty config...");
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
              .catch(e => alert("Retry Failed: " + e));
          }

          // Fallback to stop/reset UI
          document.getElementById('input-section').style.display = 'block';
          document.getElementById('scanner-container').style.display = 'none';
        });
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
          document.getElementById('input-section').style.display = 'block';
          document.getElementById('scanner-container').style.display = 'none';
          document.getElementById('result-display').style.display = 'none';
          console.log("Scanner stopped.");
        }).catch(error => {
          console.error("Failed to stop scanner. ", error);
          // If stop fails (e.g. wasn't running), force UI reset
          document.getElementById('input-section').style.display = 'block';
          document.getElementById('scanner-container').style.display = 'none';
        });
      }
    }
  </script>

</body>

</html>