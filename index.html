<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Barcode Scanner</title>
  <!-- Include html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      text-align: center;
    }

    h1 {
      color: #333;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #input-section {
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }

    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      box-sizing: border-box;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    button:active {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #ccc;
    }

    #status {
      margin: 10px 0;
      color: #666;
      font-size: 0.9rem;
    }

    #scanner-container {
      margin-top: 20px;
      display: none;
      /* Hidden until data loaded */
    }

    /* Scanner wrapper: fixed height, clips overflow */
    #scanner-wrapper {
      position: relative;
      width: 100%;
      max-height: 260px;
      overflow: hidden;
      margin: 0 auto;
      background: #000;
      border-radius: 8px;
    }

    /* #reader: normal block so html5-qrcode can measure it */
    #reader {
      width: 100%;
      display: block;
    }

    /* Hide html5-qrcode's own UI: qrbox border, shutter, controls */
    #reader__scan_region {
      border: none !important;
      box-shadow: none !important;
    }

    #reader__scan_region img,
    #reader__scan_region svg {
      display: none !important;
    }

    #reader__dashboard,
    #reader__dashboard_section_swaplink,
    #reader__dashboard_section_csr,
    #reader__filescan_input {
      display: none !important;
    }

    /* Video element: fill reader width */
    #reader video {
      width: 100% !important;
      max-width: 100% !important;
      display: block;
    }

    /* Scan result bar below camera */
    #scan-result-bar {
      margin-top: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      text-align: center;
      transition: background-color 0.3s, border-color 0.3s;
    }

    #scan-result-bar.match {
      background: #d4edda;
      border: 2px solid #28a745;
    }

    #scan-result-bar.no-match {
      background: #f8d7da;
      border: 2px solid #dc3545;
    }

    #scan-result-label {
      display: block;
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 4px;
    }

    #scan-result-bar.match #scan-result-label {
      color: #155724;
    }

    #scan-result-bar.no-match #scan-result-label {
      color: #721c24;
    }

    #scan-result-code {
      display: block;
      font-size: 1.8rem;
      font-weight: 900;
      letter-spacing: 1px;
    }

    #scan-result-bar.match #scan-result-code {
      color: #155724;
    }

    #scan-result-bar.no-match #scan-result-code {
      color: #dc3545;
    }

    /* Summary Modal */
    #summary-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #summary-modal.show {
      display: flex;
    }

    .summary-box {
      background: #fff;
      border-radius: 16px;
      padding: 28px 32px;
      text-align: center;
      min-width: 260px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    }

    .summary-box h2 {
      margin: 0 0 18px;
      font-size: 1.3rem;
      color: #333;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 1.1rem;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .summary-row:last-of-type {
      border-bottom: none;
    }

    .summary-row .label {
      color: #555;
    }

    .summary-row .value {
      font-weight: bold;
    }

    .val-total {
      color: #333;
    }

    .val-paid {
      color: #28a745;
    }

    .val-unpaid {
      color: #dc3545;
    }

    .summary-close {
      margin-top: 20px;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 32px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      width: auto;
    }

    #result-display {
      /* margin-top: 20px;  Removed as it is now above camera */
      background-color: #fff;
      /* Ensure visibility */
      border: 1px solid #ddd;
      border-radius: 12px;
      display: none;
    }

    .match {
      background-color: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      animation: pulse 0.5s ease-in-out;
    }

    .no-match {
      background-color: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .result-text {
      font-size: 2rem;
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }

    .scanned-code {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
      display: block;
      margin-top: 5px;
      word-break: break-all;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.2rem;
      }
    }

    .count-badge {
      background: #eee;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-left: 5px;
    }

    /* Scanner Overlay Styles */

    #scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      /* Let clicks pass through to camera/buttons if any */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .scan-area {
      width: 250px;
      /* Match logic config */
      height: 150px;
      /* Match logic config */
      position: relative;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      /* Shaded background */
      border-radius: 4px;
      transition: box-shadow 0.3s ease, border 0.3s ease;
    }

    .scan-area.error {
      box-shadow: 0 0 0 9999px rgba(180, 0, 0, 0.45) !important;
      border: 3px solid #ff4444;
    }

    .scan-area.error .corner {
      border-color: #ff4444;
    }

    .scan-area.success {
      box-shadow: 0 0 0 9999px rgba(0, 120, 0, 0.35) !important;
      border: 3px solid #28a745;
    }

    .scan-area.success .corner {
      border-color: #28a745;
    }

    /* Corner Markers */

    /* Corner Markers */
    .corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: #fff;
      border-style: solid;
      border-width: 0;
    }

    .top-left {
      top: -2px;
      left: -2px;
      border-top-width: 4px;
      border-left-width: 4px;
    }

    .top-right {
      top: -2px;
      right: -2px;
      border-top-width: 4px;
      border-right-width: 4px;
    }

    .bottom-left {
      bottom: -2px;
      left: -2px;
      border-bottom-width: 4px;
      border-left-width: 4px;
    }

    .bottom-right {
      bottom: -2px;
      right: -2px;
      border-bottom-width: 4px;
      border-right-width: 4px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á (Mobile Scanner)</h1>

    <div id="input-section">
      <p style="margin-top: 0; text-align: left; font-size: 0.9rem; color: #666;">
        1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .html/.mhtml ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á<br>
        2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• & ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô"
      </p>
      <div style="margin-bottom: 10px; text-align: left;">
        <input type="file" id="fileInput" accept=".html,.htm,.mhtml"
          style="display: block; width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      <textarea id="htmlInput" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î HTML <tbody>...</tbody> ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
      <button onclick="startScanner()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• & ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <div id="data-status" style="margin-top: 10px; font-weight: bold;"></div>
    </div>

    <div id="scanner-container">
      <div id="count-display" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333;">
        ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß: <span id="found-count">0</span> / <span id="total-count">0</span>
      </div>

      <div id="scanner-wrapper">
        <div id="reader"></div>
        <div id="scan-overlay">
          <div class="scan-area">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
          </div>
        </div>
      </div>

      <!-- Scan result bar: shown below camera frame -->
      <div id="scan-result-bar" style="display:none;">
        <span id="scan-result-label"></span>
        <span id="scan-result-code"></span>
      </div>

      <div style="margin-top: 20px; text-align: left;">
        <h3 style="font-size: 1rem; margin-bottom: 5px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö (<span id="scanned-list-count">0</span>):</h3>
        <ul id="scanned-list"
          style="max-height: 150px; overflow-y: auto; background: #fafafa; padding: 10px; border: 1px solid #ddd; list-style-position: inside;">
          <li style="color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
        </ul>

        <details style="margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
          <summary style="cursor: pointer; font-weight: bold; color: #007bff;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span
              id="all-list-count">0</span>)</summary>
          <ul id="all-target-list" style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding-left: 20px;">
            <!-- Populated by JS -->
          </ul>
        </details>
      </div>

      <button onclick="stopScanner()" style="margin-top: 20px; background-color: #dc3545;">‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô</button>
    </div>
  </div>

  <!-- Summary Modal -->
  <div id="summary-modal">
    <div class="summary-box">
      <h2>üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h2>
      <div class="summary-row">
        <span class="label">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        <span class="value val-total" id="sum-total">0</span>
      </div>
      <div class="summary-row">
        <span class="label">‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
        <span class="value val-paid" id="sum-paid">0</span>
      </div>
      <div class="summary-row">
        <span class="label">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢</span>
        <span class="value val-unpaid" id="sum-unpaid">0</span>
      </div>
      <button class="summary-close" onclick="closeSummary()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <script>
    let orderNumbers = new Set();
    let scannedOrders = new Set();     // ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (match)
    let notPaidScanned = new Set();    // ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢)
    let html5QrcodeScanner = null;
    let audioContext = null;

    // Initialize Audio Context on user interaction
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }

    function decodeQuotedPrintable(str) {
      // Remove soft line breaks (=\r\n, =\n, =\r)
      let decoded = str.replace(/=\r?\n/g, '');
      // Decode hex sequences (=3D -> =)
      decoded = decoded.replace(/=([0-9A-F]{2})/yi, function (match, hex) {
        return String.fromCharCode(parseInt(hex, 16));
      });
      return decoded;
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        // Put content in textarea for visibility (optional) and process
        document.getElementById('htmlInput').value = content;
        // Auto-parse
        parseOrderNumbers(content);
      };
      reader.readAsText(file);
    });

    function speakPaid() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance("‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        utterance.lang = 'th-TH';
        window.speechSynthesis.speak(utterance);
      }
    }

    function playBeep(type) {
      if (!audioContext) initAudio();

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      if (type === 'success') {
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } else if (type === 'scan') {
        // Short high-pitched beep for scan
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(1500, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } else {
        // Optional: Error beep
      }
    }

    function parseOrderNumbers(sourceText = null) {
      let input = sourceText;
      if (!input) {
        input = document.getElementById('htmlInput').value.trim();
      }

      if (!input) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
        return false;
      }

      // Check if MHTML/Quoted-Printable and decode
      if (input.includes('MIME-Version:') || input.includes('Content-Transfer-Encoding: quoted-printable') || input.includes('=3D')) {
        input = decodeQuotedPrintable(input);
      }

      // Create a dummy element to parse HTML safely
      // Wrap in table to ensure tbody/tr are preserved if missing parent tags
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = '<table>' + input + '</table>';

      // Find rows within the constructed table
      const rows = tempDiv.querySelectorAll('tr');

      orderNumbers.clear();
      let count = 0;

      rows.forEach(row => {
        // Target: First <td> in the row
        const firstTd = row.querySelector('td');
        if (firstTd) {
          const text = firstTd.textContent.trim();
          // specific check for length to avoid empty cells or headers if any
          if (text && text.length > 5) {
            orderNumbers.add(text);
            count++;
          }
        }
      });

      const statusDiv = document.getElementById('data-status');
      if (count > 0) {
        statusDiv.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        statusDiv.style.color = 'green';

        // Reset scanned sets and update display
        scannedOrders.clear();
        notPaidScanned.clear();
        document.getElementById('total-count').textContent = count;
        document.getElementById('found-count').textContent = '0';
        document.getElementById('scanned-list-count').textContent = '0';
        document.getElementById('all-list-count').textContent = count;

        // Populate All Targets List
        const allList = document.getElementById('all-target-list');
        allList.innerHTML = '';
        orderNumbers.forEach(num => {
          const li = document.createElement('li');
          li.textContent = num;
          allList.appendChild(li);
        });

        // Reset Scanned List
        const scannedList = document.getElementById('scanned-list');
        scannedList.innerHTML = '<li style="color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>';

        return true;
      } else {
        // Fallback: Check if user pasted just text or something else
        statusDiv.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ô HTML ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ <tr>...</tr>)";
        statusDiv.style.color = 'red';
        return false;
      }
    }

    let lastScannedCode = null;
    let lastScanTime = 0;
    let isZoomed = false;
    let zoomDetectionTimer = null;

    // Auto-zoom in when barcode candidate detected (called from onScanFailure with partial detection)
    function handleAutoZoom() {
      if (isZoomed || !html5QrcodeScanner) return;
      try {
        const track = html5QrcodeScanner.getRunningTrackCameraCapabilities();
        if (!track || !track.zoom) return;
        const zoomCap = track.zoom;
        const targetZoom = Math.min(zoomCap.min + 2.5, zoomCap.max);
        html5QrcodeScanner.applyVideoConstraints({ advanced: [{ zoom: targetZoom }] });
        isZoomed = true;
        console.log('Auto Zoom IN to:', targetZoom);
      } catch (e) {
        console.warn('Auto zoom error:', e);
      }
    }

    // Reset zoom back to 1.0 after successful scan
    function resetZoom() {
      if (!isZoomed || !html5QrcodeScanner) return;
      try {
        const track = html5QrcodeScanner.getRunningTrackCameraCapabilities();
        if (!track || !track.zoom) return;
        html5QrcodeScanner.applyVideoConstraints({ advanced: [{ zoom: 1.0 }] });
        isZoomed = false;
        console.log('Auto Zoom RESET to 1.0');
      } catch (e) {
        console.warn('Reset zoom error:', e);
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      // Handle on success condition with the decoded message.
      console.log(`Scan result: ${decodedText}`, decodedResult);

      const currentTime = new Date().getTime();

      // Debounce: Prevent processing the same code too quickly (e.g., within 2 seconds)
      if (decodedText === lastScannedCode && (currentTime - lastScanTime < 2000)) {
        return;
      }

      // Update last scan info
      lastScannedCode = decodedText;
      lastScanTime = currentTime;

      // Play "Scan" beep for every valid scan
      playBeep('scan');

      // Robust Extraction Logic:
      // 1. Keep only digits
      let rawDigits = decodedText.replace(/\D/g, '');
      let code = rawDigits;

      // 2. Search for the specific order prefix '036811'
      let matchIndex = rawDigits.indexOf('036811');
      if (matchIndex !== -1) {
        code = rawDigits.substring(matchIndex);
      } else {
        // 3. Fallback: Check for '36811' (missing leading zero)
        matchIndex = rawDigits.indexOf('36811');
        if (matchIndex !== -1) {
          code = '0' + rawDigits.substring(matchIndex);
        }
      }

      if (orderNumbers.has(code)) {
        // Match found
        if (!scannedOrders.has(code)) {
          scannedOrders.add(code);
          document.getElementById('found-count').textContent = scannedOrders.size;
          document.getElementById('scanned-list-count').textContent = scannedOrders.size;

          // Update Scanned List UI
          const scannedList = document.getElementById('scanned-list');
          if (scannedOrders.size === 1) {
            scannedList.innerHTML = ''; // Clear "no items" message
          }
          const li = document.createElement('li');
          li.textContent = code;
          li.style.color = 'green';
          li.style.fontWeight = 'bold';
          scannedList.insertBefore(li, scannedList.firstChild);
        }

        // Reset zoom after successful scan
        resetZoom();

        // Voice + beep
        setTimeout(() => {
          playBeep('success');
          speakPaid();
        }, 300);

        // Show GREEN result bar
        showResultBar('match', '‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', code);

      } else {
        // Non-match
        notPaidScanned.add(code);

        // Red overlay on scan frame
        const scanArea = document.querySelector('.scan-area');
        if (scanArea) {
          scanArea.classList.add('error');
          setTimeout(() => scanArea.classList.remove('error'), 1000);
        }

        // Voice + beep
        setTimeout(() => {
          playBeep('scan');
          speakNotPaid();
        }, 300);

        // Show RED result bar
        showResultBar('no-match', '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', code);
      }
    }

    function showResultBar(type, label, code) {
      // Update result bar below camera
      const bar = document.getElementById('scan-result-bar');
      document.getElementById('scan-result-label').textContent = label;
      document.getElementById('scan-result-code').textContent = code;
      bar.className = type;
      bar.style.display = 'block';

      // Update scan-area frame color
      const scanArea = document.querySelector('.scan-area');
      if (scanArea) {
        scanArea.classList.remove('success', 'error');
        scanArea.classList.add(type === 'match' ? 'success' : 'error');
        // Reset frame color after 2s
        setTimeout(() => {
          scanArea.classList.remove('success', 'error');
        }, 2000);
      }
    }

    function speakPaid() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance("‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        utterance.lang = 'th-TH';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    function speakNotPaid() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢"); // Not Paid
        utterance.lang = 'th-TH';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    function onScanFailure(error) {
      // When scan fails (no barcode yet), trigger auto-zoom with a 100ms buffer
      // to avoid jitter from rapid zoom in/out
      if (!isZoomed) {
        clearTimeout(zoomDetectionTimer);
        zoomDetectionTimer = setTimeout(() => {
          handleAutoZoom();
        }, 100);
      }
    }

    function startScanner() {
      if (!parseOrderNumbers()) return;

      // Hide input, show scanner
      document.getElementById('input-section').style.display = 'none';
      document.getElementById('scanner-container').style.display = 'block';

      // Initialize Audio
      initAudio();

      // Use Html5Qrcode class for explicit control
      if (!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("reader");
      }

      const config = {
        fps: 10
        // No qrbox: library scans full frame, our overlay provides the visual guide
      };

      // Request back camera explicitly
      // NOTE: Html5Qrcode.start throws error if config has > 1 key. 
      // We must use only { facingMode: "environment" } here, and apply resolution constraints later.
      const cameraConfig = {
        facingMode: "environment"
      };

      html5QrcodeScanner.start(
        cameraConfig,
        config,
        onScanSuccess,
        onScanFailure
      ).then(() => {
        // Apply Resolution & Auto-zoom logic after start
        setTimeout(() => {
          try {
            // Maxwell Resolution Constraints (4K ideal)
            const resolutionConstraints = {
              width: { min: 1280, ideal: 3840 },
              height: { min: 720, ideal: 2160 }
            };

            // Get current capabilities for Zoom
            const track = html5QrcodeScanner.getRunningTrackCameraCapabilities();
            console.log("Camera Capabilities:", track);

            let zoomConstraint = null;

            if (track && track.zoom) {
              const zoomCapability = track.zoom;
              // Target zoom level: 2.0x or Max if less than 2.0
              let targetZoom = Math.min(zoomCapability.max, 2.0);

              if (targetZoom < zoomCapability.min) {
                targetZoom = zoomCapability.min;
              }

              console.log(`Setting Hardware Zoom to: ${targetZoom}`);
              zoomConstraint = [{ zoom: targetZoom }];
            }

            // Combine constraints
            const finalConstraints = {
              ...resolutionConstraints,
              ...(zoomConstraint ? { advanced: zoomConstraint } : {})
            };

            console.log("Applying Constraints:", finalConstraints);
            html5QrcodeScanner.applyVideoConstraints(finalConstraints);

          } catch (e) {
            console.error("Error setting camera constraints:", e);
          }
        }, 500); // Slight delay to ensure camera is fully ready
      })
        .catch(err => {
          console.error("Error starting scanner", err);
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err);
          // Fallback to stop/reset UI
          document.getElementById('input-section').style.display = 'block';
          document.getElementById('scanner-container').style.display = 'none';
        });
    }

    function showSummary() {
      const paid = scannedOrders.size;
      const unpaid = notPaidScanned.size;
      const total = paid + unpaid;
      document.getElementById('sum-total').textContent = total;
      document.getElementById('sum-paid').textContent = paid;
      document.getElementById('sum-unpaid').textContent = unpaid;
      document.getElementById('summary-modal').classList.add('show');
    }

    function closeSummary() {
      document.getElementById('summary-modal').classList.remove('show');
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
          document.getElementById('input-section').style.display = 'block';
          document.getElementById('scanner-container').style.display = 'none';
          document.getElementById('scan-result-bar').style.display = 'none';
          showSummary();
          console.log("Scanner stopped.");
        }).catch(error => {
          console.error("Failed to stop scanner. ", error);
          document.getElementById('input-section').style.display = 'block';
          document.getElementById('scanner-container').style.display = 'none';
          showSummary();
        });
      }
    }
  </script>

</body>

</html>